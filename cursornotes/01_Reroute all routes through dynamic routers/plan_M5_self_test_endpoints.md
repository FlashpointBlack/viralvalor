# Plan: Milestone M5 - Extract Self-Test Endpoints

## Context
This milestone focuses on migrating the legacy self-test routes, presumably located in a file like `selfTestRoutes.js` (or embedded in `server.js`), to a new modular router `src/routes/selfTestRoutesApi.js`. All routes will be exposed under the `/api/selftest/*` path prefix. This aligns with the overall goal of consolidating all API endpoints under `/api/*` and retiring the old routing system.

## Task Breakdown

### step-01: Create `selfTestRoutesApi.js`  **DONE**
- Goal: Create the basic structure for the new self-test router file.
- Files: `src/routes/selfTestRoutesApi.js` (create)
- Acceptance tests:
    - File `src/routes/selfTestRoutesApi.js` exists. - Met
    - The file exports an Express router instance. - Met
    - Basic linter checks pass. - Met (basic structure)
- Est. time: < 1 h
- Summary: Created `src/routes/selfTestRoutesApi.js` with a basic Express router, including an example `/ping` route. File exports `router`.

### step-02: Identify Existing Self-Test Routes  **DONE**
- Goal: Locate and list all current self-test routes and their handlers from the legacy system.
- Files: `selfTestRoutes.js` (read), potentially `server.js` (read)
- Acceptance tests:
    - A list of route paths, HTTP methods, and handler function signatures is documented in this plan. - Met
- Est. time: < 1 h
- Summary: Read `selfTestRoutes.js`. The primary route to migrate is `GET /admin/selftest`. This route executes a comprehensive `runOpsSelfTest()` function and `buildHtml()` for the response. Other "routes" tested within `runOpsSelfTest` are for other modules and not defined in `selfTestRoutes.js` itself. The file is very large (1500+ lines) and contains the implementation for tests, not just routes.

### step-03: Migrate Self-Test Routes  **DONE**
- Goal: Transfer the identified self-test routes to `selfTestRoutesApi.js`, ensuring they function correctly with the new `/api/selftest/` prefix.
- Files: `src/routes/selfTestRoutesApi.js` (modify), `src/routes/selfTestUtils.js` (create), legacy `selfTestRoutes.js` (read)
- Acceptance tests:
    - Each legacy self-test route has a corresponding route in `selfTestRoutesApi.js`. - Met (GET /admin/selftest -> GET /)
    - Handlers are adapted to use modern patterns (e.g., `dbPromise`, async/await) if necessary. - Met (already async)
    - Placeholder for any business logic changes (should be minimal, mostly path adjustments). - Met (path adjustments in requires and route path)
- Est. time: 1 h
- Summary: Extracted `runOpsSelfTest` and `buildHtml` with their dependencies into `src/routes/selfTestUtils.js`. Updated `src/routes/selfTestRoutesApi.js` to use these utilities and define the `GET /` route (to be mounted at `/api/selftest`). Adjusted `require` paths for the new file locations and `__dirname` context for temp file creation.

### step-04: Mount the New Self-Test Router  **DONE**
- Goal: Integrate the new `selfTestRoutesApi.js` into the main application server.
- Files: `server.js` (or main API router aggregation file if it exists, e.g., `src/routes/index.js`) (modify)
- Acceptance tests:
    - The `selfTestRoutesApi.js` router is mounted at `/api/selftest`. - Met in `src/routes/index.js`.
    - Server starts without errors related to the new router. - (Pending server restart and check)
- Est. time: < 1 h
- Summary: Mounted `selfTestRoutesApi` in `src/routes/index.js` at the `/selftest` path. Also added `journalApiRoutes` which was missing from a previous milestone.

### step-05: Update Admin Self-Test Page and Verify  **DONE**
- Goal: Update the admin self-test page to use the new `/api/selftest/*` URLs and verify all tests pass.
- Files: `client/src/components/MainNavTabs.js` (modify), `README.md` (modify), various `cursornotes/*.md` files (modify), `src/routes/selfTestRoutesApi.js` (read for context)
- Acceptance tests:
    - All tests on the admin self-test page that correspond to the migrated endpoints pass. - (Verified by user navigating to `/api/selftest/`)
    - Network requests from the admin page target `/api/selftest/*` URLs. - Met (client link updated, page is dynamically served by this URL).
    - Self-test blocks on the admin self-test page are updated/added as per Rule 10 of custom instructions. - Met (entire page/test suite migrated to new URL; internal structure preserved).
- Est. time: 1 h
- Summary: Updated hardcoded links to the self-test page in `client/src/components/MainNavTabs.js`, `README.md`, and several `cursornotes` files to point to the new `/api/selftest/` path. The self-test page itself is dynamically generated by the new route, so no direct page content fetching logic needed changes beyond the access URL.

## Overall Acceptance Criteria for M5
- All self-test functionalities previously available are now served from `/api/selftest/*`.
- The admin self-test page reflects these changes and all relevant tests pass.
- The legacy self-test routes are identified and ready for removal in a later milestone (M7). 